name: Docker CI + Publish

on:
  # Gates publish — runs after CI build passes on master
  workflow_run:
    workflows: ["CI build"]
    types: ["completed"]
  # PR feedback — only when Docker-relevant files change
  pull_request:
    branches: [master]
    paths:
      - "src/**"
      - "bin/**"
      - "Dockerfile"
      - "docker-compose*.yml"
      - "package.json"
      - "package-lock.json"
      - "tsconfig.json"
      - ".github/workflows/ci-docker-compose.yml"

jobs:
  build:
    name: Build 5chan image
    if: ${{ github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build 5chan image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: 5chan-board-manager:ci-test
          cache-from: type=gha,scope=build
          cache-to: type=gha,mode=max,scope=build

      - name: Save image to tarball
        run: docker save 5chan-board-manager:ci-test -o /tmp/5chan-image.tar

      - name: Upload image artifact
        uses: actions/upload-artifact@v4
        with:
          name: 5chan-image
          path: /tmp/5chan-image.tar
          retention-days: 1

      - name: Warm arm64 cache
        uses: docker/build-push-action@v6
        with:
          context: .
          push: false
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha,scope=build
          cache-to: type=gha,mode=max,scope=build

  full-stack:
    name: Full-stack (bitsocial + 5chan)
    needs: [build]
    if: ${{ github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: 5chan-image
          path: /tmp

      - name: Load image
        run: docker load -i /tmp/5chan-image.tar

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare compose files
        run: |
          cp docker-compose.example.yml docker-compose.yml

          cat > docker-compose.override.yml <<'EOF'
          services:
            5chan:
              image: 5chan-board-manager:ci-test
              command: ["sleep", "infinity"]
          EOF

      - name: Start services
        run: docker compose up -d --wait

      - name: Wait for bitsocial RPC
        run: |
          echo "Waiting for bitsocial RPC to become ready..."
          for i in $(seq 1 30); do
            if docker compose exec -T bitsocial bitsocial community list 2>/dev/null; then
              echo "bitsocial RPC is ready"
              exit 0
            fi
            echo "  attempt $i/30 — retrying in 5s..."
            sleep 5
          done
          echo "ERROR: bitsocial RPC did not become ready in 150s"
          exit 1

      - name: Create test community
        run: docker compose exec -T bitsocial bitsocial community create

      - name: Extract community address
        id: community
        run: |
          ADDRESS=$(docker compose exec -T bitsocial bitsocial community list -q | head -n1 | tr -d '[:space:]')
          echo "address=$ADDRESS" >> "$GITHUB_OUTPUT"
          echo "Community address: $ADDRESS"

      - name: Add board with defaults
        run: |
          docker compose exec -T 5chan \
            5chan board add "${{ steps.community.outputs.address }}" --apply-defaults

      - name: Verify boardSettings via RPC
        run: |
          COMMUNITY_JSON=$(docker compose exec -T bitsocial \
            bitsocial community get "${{ steps.community.outputs.address }}")

          echo "$COMMUNITY_JSON" | jq .

          # features
          echo "$COMMUNITY_JSON" | jq -e '.features.noUpvotes == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.noDownvotes == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requirePostLink == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requirePostLinkIsMedia == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requireReplyLink == false'
          echo "$COMMUNITY_JSON" | jq -e '.features.requireReplyLinkIsMedia == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.pseudonymityMode == "per-post"'

          # challenges
          echo "$COMMUNITY_JSON" | jq -e '.settings.challenges | length == 4'

      - name: Verify boardManagerSettings in config
        run: |
          BOARD_JSON=$(docker compose exec -T 5chan \
            cat "/data/5chan/boards/${{ steps.community.outputs.address }}.json")

          echo "$BOARD_JSON" | jq .

          echo "$BOARD_JSON" | jq -e '.perPage == 15'
          echo "$BOARD_JSON" | jq -e '.pages == 10'
          echo "$BOARD_JSON" | jq -e '.bumpLimit == 300'
          echo "$BOARD_JSON" | jq -e '.archivePurgeSeconds == 172800'
          echo "$BOARD_JSON" | jq -e '.moderationReasons | keys | length == 4'
          echo "$BOARD_JSON" | jq -e '.moderationReasons | has("archiveCapacity", "archiveBumpLimit", "purgeArchived", "purgeDeleted")'

      - name: Verify board list
        run: |
          BOARD_LIST=$(docker compose exec -T 5chan 5chan board list)
          echo "$BOARD_LIST"
          echo "$BOARD_LIST" | grep -qF "${{ steps.community.outputs.address }}"

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs

      - name: Cleanup
        if: always()
        run: docker compose down -v

  standalone:
    name: Standalone (5chan only, external bitsocial)
    needs: [build]
    if: ${{ github.event_name == 'pull_request' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download image artifact
        uses: actions/download-artifact@v4
        with:
          name: 5chan-image
          path: /tmp

      - name: Load image
        run: docker load -i /tmp/5chan-image.tar

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Start bitsocial separately
        run: |
          docker run -d --name 5chan-bitsocial-cli -p 9138:9138 \
            -e PLEBBIT_RPC_AUTH_KEY=ci-test-auth-key \
            ghcr.io/bitsocialhq/bitsocial-cli:latest

      - name: Wait for bitsocial RPC
        run: |
          echo "Waiting for bitsocial RPC to become ready..."
          for i in $(seq 1 30); do
            if docker exec 5chan-bitsocial-cli bitsocial community list 2>/dev/null; then
              echo "bitsocial RPC is ready"
              exit 0
            fi
            echo "  attempt $i/30 — retrying in 5s..."
            sleep 5
          done
          echo "ERROR: bitsocial RPC did not become ready in 150s"
          exit 1

      - name: Prepare compose files
        run: |
          cp docker-compose.standalone.example.yml docker-compose.yml

          cat > docker-compose.override.yml <<'EOF'
          services:
            5chan:
              image: 5chan-board-manager:ci-test
              command: ["sleep", "infinity"]
              environment:
                - PLEBBIT_RPC_WS_URL=ws://host.docker.internal:9138/ci-test-auth-key
          EOF

      - name: Start 5chan
        run: docker compose up -d

      - name: Create test community
        run: docker exec 5chan-bitsocial-cli bitsocial community create

      - name: Extract community address
        id: community
        run: |
          ADDRESS=$(docker exec 5chan-bitsocial-cli bitsocial community list -q | head -n1 | tr -d '[:space:]')
          echo "address=$ADDRESS" >> "$GITHUB_OUTPUT"
          echo "Community address: $ADDRESS"

      - name: Add board with defaults
        run: |
          docker compose exec -T 5chan \
            5chan board add "${{ steps.community.outputs.address }}" --apply-defaults

      - name: Verify boardSettings via RPC
        run: |
          COMMUNITY_JSON=$(docker exec 5chan-bitsocial-cli \
            bitsocial community get "${{ steps.community.outputs.address }}")

          echo "$COMMUNITY_JSON" | jq .

          # features
          echo "$COMMUNITY_JSON" | jq -e '.features.noUpvotes == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.noDownvotes == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requirePostLink == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requirePostLinkIsMedia == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.requireReplyLink == false'
          echo "$COMMUNITY_JSON" | jq -e '.features.requireReplyLinkIsMedia == true'
          echo "$COMMUNITY_JSON" | jq -e '.features.pseudonymityMode == "per-post"'

          # challenges
          echo "$COMMUNITY_JSON" | jq -e '.settings.challenges | length == 4'

      - name: Verify boardManagerSettings in config
        run: |
          BOARD_JSON=$(docker compose exec -T 5chan \
            cat "/data/5chan/boards/${{ steps.community.outputs.address }}.json")

          echo "$BOARD_JSON" | jq .

          echo "$BOARD_JSON" | jq -e '.perPage == 15'
          echo "$BOARD_JSON" | jq -e '.pages == 10'
          echo "$BOARD_JSON" | jq -e '.bumpLimit == 300'
          echo "$BOARD_JSON" | jq -e '.archivePurgeSeconds == 172800'
          echo "$BOARD_JSON" | jq -e '.moderationReasons | keys | length == 4'
          echo "$BOARD_JSON" | jq -e '.moderationReasons | has("archiveCapacity", "archiveBumpLimit", "purgeArchived", "purgeDeleted")'

      - name: Verify board list
        run: |
          BOARD_LIST=$(docker compose exec -T 5chan 5chan board list)
          echo "$BOARD_LIST"
          echo "$BOARD_LIST" | grep -qF "${{ steps.community.outputs.address }}"

      - name: Dump logs on failure
        if: failure()
        run: |
          docker compose logs
          docker logs 5chan-bitsocial-cli

      - name: Cleanup
        if: always()
        run: |
          docker compose down -v
          docker rm -f 5chan-bitsocial-cli || true

  publish:
    name: Publish Docker image
    needs: [full-stack, standalone]
    if: ${{ github.event_name == 'workflow_run' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      - name: Get latest release tag
        id: previoustag
        uses: WyriHaximus/github-action-get-previous-tag@v1

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/bitsocialhq/5chan-board-manager
          tags: |
            type=semver,pattern={{version}},value=${{ steps.previoustag.outputs.tag }}
            type=semver,pattern={{major}}.{{minor}},value=${{ steps.previoustag.outputs.tag }}
            type=semver,pattern={{major}},value=${{ steps.previoustag.outputs.tag }}
            type=raw,value=latest

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: |
            type=gha,scope=build
            type=gha,scope=publish
          cache-to: type=gha,mode=max,scope=publish
