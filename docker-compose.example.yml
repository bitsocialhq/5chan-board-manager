# Example Docker Compose: 5chan board manager with bitsocial-cli (Plebbit RPC)
#
# Quick start:
#   cp docker-compose.example.yml docker-compose.yml
#   # Edit /path/to/config.json with your boards (see README.md)
#   docker compose up -d
#
# View logs:
#   docker compose logs -f 5chan

services:
  bitsocial:
    image: ghcr.io/bitsocialhq/bitsocial-cli:latest
    container_name: 5chan-bitsocial-cli
    restart: unless-stopped
    ports:
      - "9138:9138"
    volumes:
      - bitsocial-data:/data
      - bitsocial-logs:/logs
    environment:
      # Fixed RPC auth key so 5chan can connect without extracting it from logs.
      # Change this to your own random string (e.g.: openssl rand -base64 32 | tr -d '/+=')
      - PLEBBIT_RPC_AUTH_KEY=TFCh0joRU60KwlfVaprP2uenw7NCdAwsBCF5UDoVg
    # Optional: increase UDP buffer limits for QUIC transport (used by Kubo/IPFS).
    # Prevents: "failed to sufficiently increase receive buffer size" warning.
    # Uncomment if you are running Docker with root privileges.
    # sysctls:
    #   - net.core.rmem_max=7500000
    #   - net.core.wmem_max=7500000
    healthcheck:
      test: ["CMD", "node", "-e", "const net=require('net');const s=net.connect(9138,'localhost',()=>{s.end();process.exit(0)});s.on('error',()=>process.exit(1));setTimeout(()=>process.exit(1),5000)"]
      interval: 30s
      timeout: 10s
      start_period: 60s
      retries: 3

  5chan:
    image: ghcr.io/bitsocialhq/5chan-board-manager:latest
    container_name: 5chan
    restart: unless-stopped
    depends_on:
      bitsocial:
        condition: service_healthy
    volumes:
      - 5chan-data:/data
    environment:
      # Must match PLEBBIT_RPC_AUTH_KEY on the bitsocial service above
      - PLEBBIT_RPC_WS_URL=ws://bitsocial:9138/TFCh0joRU60KwlfVaprP2uenw7NCdAwsBCF5UDoVg

volumes:
  bitsocial-data:
  bitsocial-logs:
  5chan-data:
